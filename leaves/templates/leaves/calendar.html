<!doctype html>
<html>
<head>
  {% load static %}
  <link rel="icon" href="{% static 'favicon.ico' %}">
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'favicon-32x32.png' %}">
  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'apple-touch-icon.png' %}">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>íœ´ë¬´ ë‹¬ë ¥</title>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    html, body { height: 100%; }
    body {
      margin: 0;
      padding: 10px;
      font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Arial;
      overflow-x: hidden;
    }

    /* âœ… ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šê²Œ í­ ì œí•œ (ì—¬ê¸° ìˆ«ìë§Œ ì¡°ì ˆí•˜ë©´ ì „ì²´ í¬ê¸° ëŠë‚Œì´ ë°”ë€œ) */
    #calendar {
      width: 100%;
      max-width: 1250px;
      margin: 0 auto;
    }

    /* âœ… ë‹¬ë ¥ì´ ì„¸ë¡œë¡œ ë„ˆë¬´ ì»¤ì§€ëŠ” ê²ƒ ë°©ì§€: ë‚ ì§œì¹¸ ìµœì†Œ ë†’ì´ ì‚´ì§ ì¤„ì„ */
    .fc .fc-daygrid-day-frame { min-height: 90px; }
    @media (min-width: 1400px) {
      .fc .fc-daygrid-day-frame { min-height: 100px; }
    }

    /* ===== Modal ===== */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .modal {
      width: 100%;
      max-width: 380px;
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .modal h3 { margin: 0 0 8px; font-size: 18px; }
    .modal .sub { color: #666; font-size: 13px; margin-bottom: 12px; }
    .modal input {
      width: 100%;
      font-size: 18px;
      padding: 12px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      outline: none;
    }
    .modal .row { display: flex; gap: 10px; margin-top: 12px; }
    .btn {
      flex: 1;
      border: 0;
      border-radius: 10px;
      padding: 12px;
      font-size: 16px;
      cursor: pointer;
    }
    .btn-cancel { background: #eee; }
    .btn-ok { background: #111; color: #fff; }
    .error { color: #d00; font-size: 12px; margin-top: 8px; min-height: 16px; }

    /* ===== ìš”ì¼ ìƒ‰ìƒ ===== */
    .fc .fc-col-header-cell.fc-day-sun .fc-col-header-cell-cushion { color: #d00; font-weight: 700; }
    .fc .fc-col-header-cell.fc-day-sat .fc-col-header-cell-cushion { color: #06c; font-weight: 700; }
    .fc .fc-daygrid-day.fc-day-sun .fc-daygrid-day-number { color: #d00; font-weight: 700; }
    .fc .fc-daygrid-day.fc-day-sat .fc-daygrid-day-number { color: #06c; font-weight: 700; }

    /* ===== ì´ë²¤íŠ¸ ê¸€ì ì˜ë¦¼ ë°©ì§€ + ê°€ë…ì„± ===== */
    .fc .fc-daygrid-event { white-space: normal; }
    .fc .fc-daygrid-event .fc-event-title { white-space: normal; }
    .fc .fc-daygrid-event .fc-event-title,
    .fc .fc-daygrid-event .fc-event-title-container {
      font-size: 12px;
      line-height: 1.15;
      font-weight: 700;
    }

    /* ë°˜ì°¨ ë¼ë²¨(ì˜¤ì „/ì˜¤í›„) í°ìƒ‰ */
    .fc-half-label {
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      line-height: 1.1;
      margin-top: 2px;
    }

    /* í—¤ë” ëª¨ë°”ì¼ ì¤„ë°”ê¿ˆ */
    .fc .fc-header-toolbar { gap: 8px; }
    .fc .fc-toolbar-chunk { display: flex; align-items: center; gap: 8px; }
    @media (max-width: 480px) {
      .fc .fc-header-toolbar { flex-wrap: wrap; }
      .fc .fc-toolbar-title { font-size: 22px; }
      .fc .fc-button { padding: 6px 10px; font-size: 14px; }
      .fc .fc-daygrid-day-frame { min-height: 78px; }
    }

    /* ===== +N(ë”ë³´ê¸°) íŒì˜¤ë²„ë§Œ ë‹¤í¬(ê²€ì •) ìŠ¤íƒ€ì¼ ===== */
      .fc .fc-more-popover{
        background: #111 !important;
        border: 1px solid #333 !important;
        box-shadow: 0 12px 30px rgba(0,0,0,0.35) !important;
      }

      .fc .fc-more-popover .fc-popover-header{
        background: #111 !important;
        color: #fff !important;
        border-bottom: 1px solid #333 !important;
      }

      /* í—¤ë” íƒ€ì´í‹€(ë‚ ì§œ) */
      .fc .fc-more-popover .fc-popover-title{
        color: #fff !important;
        font-weight: 700;
      }

      /* ë‹«ê¸°(X) ë²„íŠ¼ */
      .fc .fc-more-popover .fc-popover-close{
        color: #fff !important;
        opacity: 0.9;
      }
      .fc .fc-more-popover .fc-popover-close:hover{
        opacity: 1;
      }

      /* íŒì˜¤ë²„ ì•ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
      .fc .fc-more-popover .fc-popover-body{
        background: #111 !important;
        color: #fff !important;
      }

      /* íŒì˜¤ë²„ ì•ˆ ì´ë²¤íŠ¸(ë°”) í…ìŠ¤íŠ¸ëŠ” í°ìƒ‰ìœ¼ë¡œ */
      .fc .fc-more-popover .fc-event,
      .fc .fc-more-popover .fc-event .fc-event-title,
      .fc .fc-more-popover .fc-event .fc-event-time{
        color: #fff !important;
      }

      /* ë©”ëª¨ ì´ë²¤íŠ¸(íšŒìƒ‰ ê³„ì—´) */
      .fc .fc-memo-event,
      .fc .fc-memo-event .fc-event-main {
        background: rgba(0,0,0,0.65) !important;
        border-color: rgba(0,0,0,0.65) !important;
      }
      .fc .fc-memo-event .fc-event-title {
        color: #fff !important;
        font-weight: 600;
      }
      
      /* ê³µíœ´ì¼ ì´ë²¤íŠ¸ë¥¼ ê¸€ìë§Œ ì‹¬í”Œí•˜ê²Œ(ë°°ê²½ ì—†ì´) + ë¹¨ê°„ìƒ‰ */
      .fc-holiday-event,
      .fc-holiday-event .fc-event-main,
      .fc-holiday-event .fc-event-title {
        background: transparent !important;
        border: 0 !important;
        color: #d00 !important;
        font-weight: 700;
      }
      
      /* ê³µíœ´ì¼ ì´ë²¤íŠ¸ê°€ ìˆëŠ” ë‚ ì§œ ì…€ */
      .fc-daygrid-day:has(.fc-holiday-event)
        .fc-daygrid-day-number {
        color: #d00 !important;
        font-weight: 700;
      }

      /* ì›”(í¬ê²Œ) + ë…„ë„(ì‘ê²Œ) */
      .fc-title-wrap{
        display:flex;
        align-items:flex-end;
        gap:10px;
      }
      .fc-title-month{
        font-size: 34px;
        font-weight: 800;
        line-height: 1;
      }
      .fc-title-year{
        font-size: 16px;
        font-weight: 600;
        opacity: .7;
        line-height: 1;
        transform: translateY(-2px); /* ì‚´ì§ ìœ„ë¡œ(ì·¨í–¥) */
      }

      /* âœ… íƒ€ì´í‹€: ì›” í¬ê²Œ + ë…„ ì‘ê²Œ */
        .fc .fc-toolbar-title{
          display:flex;
          align-items:baseline;
          gap:10px;
        }

        .fc-title-month{
          font-size:40px;    /* ì›” í¬ê²Œ */
          font-weight:800;
          line-height:1;
        }

        .fc-title-year{
          font-size:16px;    /* ë…„ ì‘ê²Œ */
          font-weight:600;
          opacity:.75;
          line-height:1;
        }

  
  </style>
</head>

<body>
  {% if copy_msg %}
  <div id="copyBox" style="
      border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:12px 0;
      background:#fffbe6;">
    <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
      <b>âœ… ì‹ ì²­ ë‚´ìš©(ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸°)</b>
      <button type="button" onclick="copyToClipboard()"
              style="padding:8px 10px; border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer;">
        ë³µì‚¬
      </button>
    </div>

    <textarea id="copyText" readonly
              style="width:100%; margin-top:10px; min-height:130px; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:14px;">{{ copy_msg }}</textarea>

    <div id="copyHint" style="margin-top:8px; font-size:13px; color:#555;"></div>
  </div>

  <script>
    function copyToClipboard() {
      const txt = document.getElementById("copyText").value;

      // ìµœì‹  ë¸Œë¼ìš°ì €
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(txt).then(() => {
          document.getElementById("copyHint").innerText = "âœ… ë³µì‚¬ë¨! ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.";
        }).catch(() => fallbackCopy());
      } else {
        fallbackCopy();
      }

      function fallbackCopy() {
        const ta = document.getElementById("copyText");
        ta.focus();
        ta.select();
        try {
          document.execCommand("copy");
          document.getElementById("copyHint").innerText = "âœ… ë³µì‚¬ë¨! ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.";
        } catch (e) {
          document.getElementById("copyHint").innerText = "ë³µì‚¬ ì‹¤íŒ¨ ğŸ˜¥ í…ìŠ¤íŠ¸ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ì§ì ‘ ë³µì‚¬í•˜ì„¸ìš”.";
        }
      }
    }

    // í˜ì´ì§€ ëœ¨ìë§ˆì ìë™ ì„ íƒ(ì›í•˜ë©´)
    // document.getElementById("copyText").select();
  </script>
{% endif %}


  <div id="calendar"></div>

  <!-- ===== Modal ===== -->
  <div id="authModalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <h3 id="authTitle">íœ´ë¬´ ì‹ ì²­</h3>
      <div class="sub">
        ì„ íƒ ë‚ ì§œ: <b id="selectedDateText">-</b><br/>
        ìƒë…„ì›”ì¼ 6ìë¦¬(ì˜ˆ: 760910)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
      </div>

      <input id="birthInput" inputmode="numeric" autocomplete="one-time-code"
             placeholder="ìƒë…„ì›”ì¼ 6ìë¦¬" maxlength="6" />

      <div id="authError" class="error"></div>

      <div class="row">
        <button type="button" class="btn btn-cancel" id="btnCancel">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-ok" id="btnOk">í™•ì¸</button>
      </div>
    </div>
  </div>

  <script>
    const EVENTS_URL = "{% url 'leaves:events_api' %}";
    const REQUEST_NEW_URL = "{% url 'leaves:request_new' %}";

    // ===== Modal helpers =====
    const backdrop = document.getElementById('authModalBackdrop');
    const selectedDateText = document.getElementById('selectedDateText');
    const birthInput = document.getElementById('birthInput');
    const authError = document.getElementById('authError');
    const btnCancel = document.getElementById('btnCancel');
    const btnOk = document.getElementById('btnOk');

    let selectedDateStr = null;

    function openAuthModal(dateStr) {
      selectedDateStr = dateStr;
      selectedDateText.textContent = dateStr;
      authError.textContent = '';
      birthInput.value = '';
      backdrop.style.display = 'flex';
      backdrop.setAttribute('aria-hidden', 'false');
      setTimeout(() => birthInput.focus(), 50);
    }

    function closeAuthModal() {
      backdrop.style.display = 'none';
      backdrop.setAttribute('aria-hidden', 'true');
      selectedDateStr = null;
    }

    function goRequestNew() {
      const birth = birthInput.value.trim();
      if (!selectedDateStr) return;

      if (!/^\d{6}$/.test(birth)) {
        authError.textContent = 'ìƒë…„ì›”ì¼ 6ìë¦¬ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 760910)';
        birthInput.focus();
        return;
      }

      window.location.href =
        `${REQUEST_NEW_URL}?date=${encodeURIComponent(selectedDateStr)}&birth=${encodeURIComponent(birth)}`;
    }

    btnCancel.addEventListener('click', closeAuthModal);
    btnOk.addEventListener('click', goRequestNew);

    backdrop.addEventListener('click', (e) => {
      if (e.target === backdrop) closeAuthModal();
    });

    birthInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') goRequestNew();
      if (e.key === 'Escape') closeAuthModal();
    });

    // ===== FullCalendar =====
    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        dayMaxEventRows: 4,
        moreLinkClick: 'popover',

        /* âœ… ì—¬ê¸°! ë‹¬ë ¥ì´ "ëœ ì»¤ì§€ê²Œ" ë§Œë“œëŠ” í•µì‹¬ ì˜µì…˜ */
        aspectRatio: 2.05,   // ìˆ«ì â†‘ = ë” ë‚©ì‘(ì„¸ë¡œ ëœ ì”€). 1.8~2.2 ì‚¬ì´ì—ì„œ ì·¨í–¥ëŒ€ë¡œ

        height: 'auto',
        events: EVENTS_URL,

        headerToolbar: {
          left: 'title',
          center: '',
          right: 'myLeave today prev,next'
        },

        customButtons: {
          customTitle: {
            text: '',   // ì‹¤ì œ í…ìŠ¤íŠ¸ëŠ” JSë¡œ ì£¼ì…
          },
          myLeave: {
            text: 'ë‚´ ì—°ì°¨ ë³´ê¸°',
            click: function () {
              window.location.href = "{% url 'leaves:me_lookup' %}";
            }
          }
        },

        buttonText: { today: 'today' },

        datesSet: function(info) {
            // currentStartëŠ” "í˜„ì¬ ë‹¬ë ¥ í™”ë©´ì˜ ì‹œì‘ ì£¼"ë¼ì„œ ì›”ì´ ì–´ê¸‹ë‚  ìˆ˜ ìˆìŒ
            // titleì— í‘œì‹œë˜ëŠ” ë‹¬ì€ viewì˜ activeStart/currentStartë³´ë‹¤
            // viewì˜ currentStartë¥¼ ì“°ë©´ ê°€ë” ì „ì›”ë¡œ ë³´ì¼ ìˆ˜ ìˆì–´ì„œ,
            // "í˜„ì¬ viewì˜ ì¤‘ì‹¬ ë‹¬"ì„ ì•ˆì •ì ìœ¼ë¡œ ì¡ê¸° ìœ„í•´ info.view.currentStartë¥¼ ë³´ì •
            const d = new Date(info.view.currentStart);

            // âœ… í‘œì‹œí•  ë‹¬(ìˆ«ì) / ë…„ë„
            const month = d.getMonth() + 1;   // 1~12
            const year = d.getFullYear();

            const titleEl = document.querySelector('.fc .fc-toolbar-title');
            if (titleEl) {
              titleEl.innerHTML = `
                <span class="fc-title-month">${month}</span>
                <span class="fc-title-year">${year}</span>
              `;
            }
          },

        dateClick: function(info) {
          const today = new Date();
          today.setHours(0,0,0,0);          // ì˜¤ëŠ˜ 00:00 ê¸°ì¤€
          const clicked = new Date(info.dateStr);

          if (clicked < today) {
            alert('ê³¼ê±° ë‚ ì§œì—ëŠ” ì—°ì°¨ë¥¼ ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;                         // âŒ ì—¬ê¸°ì„œ ì¢…ë£Œ
          }

        openAuthModal(info.dateStr);      // âœ… ì˜¤ëŠ˜ ì´í›„ë§Œ í—ˆìš©
          },
        
        dayCellDidMount: function(arg) {
            const today = new Date();
            today.setHours(0,0,0,0);

            const cellDate = new Date(arg.date);
            cellDate.setHours(0,0,0,0);

            if (cellDate < today) {
              // ë°°ê²½ë§Œ ì‚´ì§
              arg.el.style.backgroundColor = 'rgba(0,0,0,0.03)';
            }
          },  


        // âœ… ê´„í˜¸ ì œê±° + ì˜¤ì „/ì˜¤í›„ í°ìƒ‰
        eventContent: function(arg) {
            const isMobile = window.matchMedia('(max-width: 480px)').matches;

            const wrap = document.createElement('div');
            wrap.style.lineHeight = '1.15';

            const half = arg.event.extendedProps.halfLabel; // "ì˜¤ì „"/"ì˜¤í›„"/""

            if (!isMobile && half) {
              // âœ… PC: í•œ ì¤„ "ì´ë¦„-ì˜¤ì „"
              const oneLine = document.createElement('div');
              oneLine.textContent = `${arg.event.title}-${half}`;
              wrap.appendChild(oneLine);
              return { domNodes: [wrap] };
            }

            // âœ… ëª¨ë°”ì¼(ë˜ëŠ” half ì—†ìŒ): ê¸°ì¡´ ê·¸ëŒ€ë¡œ (ì´ë¦„ / ì•„ë˜ ë¼ë²¨)
            const name = document.createElement('div');
            name.textContent = arg.event.title;
            wrap.appendChild(name);

            if (half) {
              const sub = document.createElement('div');
              sub.textContent = half;
              sub.className = 'fc-half-label';
              wrap.appendChild(sub);
            }

            return { domNodes: [wrap] };
          },

      });

      calendar.render();

      // ë Œë” ì§í›„ í­ ê³„ì‚° ë³´ì • (ê°„í—ì  í‹€ì–´ì§ ë°©ì§€)
      setTimeout(() => calendar.updateSize(), 0);
      window.addEventListener('resize', () => calendar.updateSize());
    });

  </script>
</body>
</html>
