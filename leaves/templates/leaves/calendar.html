<!doctype html>
<html>
<head>
  {% load static %}
  <link rel="icon" href="{% static 'favicon.ico' %}">
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'favicon-32x32.png' %}">
  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'apple-touch-icon.png' %}">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>íœ´ë¬´ ë‹¬ë ¥</title>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
          /* ===== ê³µí†µ: ë©”ëª¨ ì´ë²¤íŠ¸ ê¸°ë³¸ ===== */
      .fc-daygrid-event.fc-memo-event,
      .fc-daygrid-event.fc-memo-event .fc-event-main,
      .fc-daygrid-event.fc-memo-event .fc-event-main-frame,
      .fc-daygrid-event.fc-memo-event .fc-event-title-container {
        border: 0 !important;
        box-shadow: none !important;
      }

      /* ë§í’ì„ /ëª¨ì–‘ */
      .fc-daygrid-event.fc-memo-event {
        border-radius: 8px !important;
        padding: 2px 6px !important;
      }

      /* íƒ€ì´í‹€ + í´ë¦­ìœ ë„(â€¦ / â€º / â“˜ ë“±) */
      .fc-daygrid-event.fc-memo-event .memo-title {
        font-weight: 800 !important;
      }

      .fc-daygrid-event.fc-memo-event .memo-hint {
        opacity: .85;
        font-weight: 900;
        margin-left: 2px;
      }

      /* PC: í•œ ì¤„ë§Œ */
      .memo-one-line .memo-title{
        display:block;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }

      /* ëª¨ë°”ì¼: 2ì¤„ë§Œ (í˜¸í™˜ì„± ê²½ê³  í•´ê²° í¬í•¨) */
      .memo-clamp-2 .memo-title{
        display:-webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        line-clamp: 2;     /* âœ… í‘œì¤€ ì†ì„± */
        overflow:hidden;
      }

      /* ===== ìƒ‰ìƒ í´ë˜ìŠ¤ë³„ ë°°ê²½/ê¸€ììƒ‰ ===== */
      .fc-daygrid-event.fc-memo-event.memo-yellow,
      .fc-daygrid-event.fc-memo-event.memo-yellow .fc-event-main {
        background:#FFD54A !important;
        border-color:#FFD54A !important;
      }
      .fc-daygrid-event.fc-memo-event.memo-yellow .memo-title,
      .fc-daygrid-event.fc-memo-event.memo-yellow .fc-event-title,
      .fc-daygrid-event.fc-memo-event.memo-yellow .fc-event-time {
        color:#2b2400 !important;
      }

      .fc-daygrid-event.fc-memo-event.memo-blue,
      .fc-daygrid-event.fc-memo-event.memo-blue .fc-event-main {
        background:#3B82F6 !important;
        border-color:#3B82F6 !important;
      }
      .fc-daygrid-event.fc-memo-event.memo-blue .memo-title,
      .fc-daygrid-event.fc-memo-event.memo-blue .fc-event-title,
      .fc-daygrid-event.fc-memo-event.memo-blue .fc-event-time {
        color:#ffffff !important;
      }

      .fc-daygrid-event.fc-memo-event.memo-green,
      .fc-daygrid-event.fc-memo-event.memo-green .fc-event-main {
        background:#16A34A !important;
        border-color:#16A34A !important;
      }
      .fc-daygrid-event.fc-memo-event.memo-green .memo-title,
      .fc-daygrid-event.fc-memo-event.memo-green .fc-event-title,
      .fc-daygrid-event.fc-memo-event.memo-green .fc-event-time {
        color:#eaffea !important;
      }

      .fc-daygrid-event.fc-memo-event.memo-red,
      .fc-daygrid-event.fc-memo-event.memo-red .fc-event-main {
        background:#EF4444 !important;
        border-color:#EF4444 !important;
      }
      .fc-daygrid-event.fc-memo-event.memo-red .memo-title,
      .fc-daygrid-event.fc-memo-event.memo-red .fc-event-title,
      .fc-daygrid-event.fc-memo-event.memo-red .fc-event-time {
        color:#ffffff !important;
      }

      /* ===== ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ===== */
      .memo-backdrop{
        position:fixed; inset:0;
        background:rgba(0,0,0,.45);
        display:flex; align-items:center; justify-content:center;
        z-index:9999;
        padding:16px;
      }
      .memo-modal{
        width:min(560px, 100%);
        background:#fff;
        border-radius:14px;
        overflow:hidden;
        box-shadow:0 10px 30px rgba(0,0,0,.25);
      }
      .memo-modal-header{
        display:flex; align-items:center; justify-content:space-between;
        padding:12px 14px;
        border-bottom:1px solid rgba(0,0,0,.08);
      }
      .memo-modal-title{ font-weight:900; font-size:16px; }
      .memo-modal-close{
        border:0; background:transparent; font-size:18px; cursor:pointer;
      }
      .memo-modal-body{
        padding:14px;
        white-space:pre-wrap;
        line-height:1.45;
        font-size:14px;
      }



  </style>
</head>

<body>
  {% if copy_msg %}
  <div id="copyBox" style="
    position: fixed;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,.15);
    max-width: 90%;
    z-index: 9999;
  ">
    <textarea id="copyText" readonly
      style="width:100%; height:120px; font-size:13px;">{{ copy_msg }}</textarea>

    <div style="margin-top:8px; display:flex; gap:8px;">
      <button onclick="copyText()" style="flex:1;">ğŸ“‹ ë³µì‚¬</button>
      <!-- <button type="button" class="only-mobile" onclick="shareText()" style="flex:1;">ğŸ’¬ ê³µìœ </button> -->
    </div>

    <div id="copyStatus"
         style="margin-top:6px; font-size:13px; color:#555; opacity:0; transition:opacity .5s;">
    </div>
  </div>
  {% endif %}

  



  <div id="calendar"></div>

  <!-- ===== Modal ===== -->
  <div id="authModalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <h3 id="authTitle">íœ´ë¬´ ì‹ ì²­</h3>
      <div class="sub">
        ì„ íƒ ë‚ ì§œ: <b id="selectedDateText">-</b><br/>
        ìƒë…„ì›”ì¼ 6ìë¦¬(ì˜ˆ: 760910)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
      </div>

      <input id="birthInput" inputmode="numeric" autocomplete="one-time-code"
             placeholder="ìƒë…„ì›”ì¼ 6ìë¦¬" maxlength="6" />

      <div id="authError" class="error"></div>

      <div class="row">
        <button type="button" class="btn btn-cancel" id="btnCancel">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-ok" id="btnOk">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- âœ… Memo Modal -->
    <div id="memoModalBackdrop" class="memo-backdrop" aria-hidden="true" style="display:none;">
      <div class="memo-modal" role="dialog" aria-modal="true" aria-labelledby="memoModalTitle">
        <div class="memo-modal-header">
          <div id="memoModalTitle" class="memo-modal-title"></div>
          <button type="button" id="memoModalClose" class="memo-modal-close" aria-label="ë‹«ê¸°">âœ•</button>
        </div>
        <div id="memoModalBody" class="memo-modal-body"></div>
      </div>
    </div>


<script>
  const EVENTS_URL = "{% url 'leaves:events_api' %}";
  const REQUEST_NEW_URL = "{% url 'leaves:request_new' %}";

  // ===== Modal helpers (ê¸°ì¡´ ì¸ì¦ ëª¨ë‹¬) =====
  const backdrop = document.getElementById('authModalBackdrop');
  const selectedDateText = document.getElementById('selectedDateText');
  const birthInput = document.getElementById('birthInput');
  const authError = document.getElementById('authError');
  const btnCancel = document.getElementById('btnCancel');
  const btnOk = document.getElementById('btnOk');

  let selectedDateStr = null;

  function openAuthModal(dateStr) {
    selectedDateStr = dateStr;
    selectedDateText.textContent = dateStr;
    authError.textContent = '';
    birthInput.value = '';
    backdrop.style.display = 'flex';
    backdrop.setAttribute('aria-hidden', 'false');
    setTimeout(() => birthInput.focus(), 50);
  }

  function closeAuthModal() {
    backdrop.style.display = 'none';
    backdrop.setAttribute('aria-hidden', 'true');
    selectedDateStr = null;
  }

  function goRequestNew() {
    const birth = birthInput.value.trim();
    if (!selectedDateStr) return;

    if (!/^\d{6}$/.test(birth)) {
      authError.textContent = 'ìƒë…„ì›”ì¼ 6ìë¦¬ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 760910)';
      birthInput.focus();
      return;
    }

    window.location.href =
      `${REQUEST_NEW_URL}?date=${encodeURIComponent(selectedDateStr)}&birth=${encodeURIComponent(birth)}`;
  }

  btnCancel.addEventListener('click', closeAuthModal);
  btnOk.addEventListener('click', goRequestNew);

  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) closeAuthModal();
  });

  birthInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') goRequestNew();
    if (e.key === 'Escape') closeAuthModal();
  });

  // ===== âœ… Memo Modal (ìƒˆë¡œ ì¶”ê°€) =====
  const memoBackdrop = document.getElementById("memoModalBackdrop");
  const memoTitleEl = document.getElementById("memoModalTitle");
  const memoBodyEl = document.getElementById("memoModalBody");
  const memoCloseBtn = document.getElementById("memoModalClose");

  function openMemoModal(title, content) {
    memoTitleEl.textContent = title || "(ì œëª© ì—†ìŒ)";
    memoBodyEl.textContent = content || "";
    memoBackdrop.style.display = "flex";
    memoBackdrop.setAttribute("aria-hidden", "false");
  }

  function closeMemoModal() {
    memoBackdrop.style.display = "none";
    memoBackdrop.setAttribute("aria-hidden", "true");
  }

  memoCloseBtn && memoCloseBtn.addEventListener("click", closeMemoModal);
  memoBackdrop && memoBackdrop.addEventListener("click", (e) => {
    if (e.target === memoBackdrop) closeMemoModal();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeMemoModal();
  });

  // ===== FullCalendar =====
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      dayMaxEventRows: 4,
      moreLinkClick: 'popover',
      aspectRatio: 2.05,
      height: 'auto',
      events: EVENTS_URL,

      headerToolbar: {
        left: 'title',
        center: '',
        right: 'myLeave today prev,next'
      },

      customButtons: {
        customTitle: { text: '' },
        myLeave: {
          text: 'ë‚´ ì—°ì°¨ ë³´ê¸°',
          click: function () {
            window.location.href = "{% url 'leaves:me_lookup' %}";
          }
        }
      },

      buttonText: { today: 'today' },

      datesSet: function(info) {
        const d = new Date(info.view.currentStart);
        const month = d.getMonth() + 1;
        const year = d.getFullYear();

        const titleEl = document.querySelector('.fc .fc-toolbar-title');
        if (titleEl) {
          titleEl.innerHTML = `
            <span class="fc-title-month">${month}</span>
            <span class="fc-title-year">${year}</span>
          `;
        }
      },

      dateClick: function(info) {
        const today = new Date();
        today.setHours(0,0,0,0);
        const clicked = new Date(info.dateStr);

        if (clicked < today) {
          alert('ê³¼ê±° ë‚ ì§œì—ëŠ” ì—°ì°¨ë¥¼ ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        openAuthModal(info.dateStr);
      },

      dayCellDidMount: function(arg) {
        const today = new Date();
        today.setHours(0,0,0,0);

        const cellDate = new Date(arg.date);
        cellDate.setHours(0,0,0,0);

        if (cellDate < today) {
          arg.el.style.backgroundColor = 'rgba(0,0,0,0.03)';
        }
      },

      // âœ… ë©”ëª¨: íƒ€ì´í‹€ë§Œ + í´ë¦­ìœ ë„(â€¦) / ëª¨ë°”ì¼ 2ì¤„
      eventContent: function(arg) {
        const isMobile = window.matchMedia('(max-width: 480px)').matches;
        const wrap = document.createElement('div');

        const isMemo = String(arg.event.id).startsWith("memo-");
        const half = arg.event.extendedProps.halfLabel;

        if (isMemo) {
          wrap.className = "fc-event-wrap " + (isMobile ? "memo-clamp-2" : "memo-one-line");

          const title = document.createElement("div");
          title.className = "memo-title";
          title.textContent = arg.event.title;

          const hint = document.createElement("span");
          hint.className = "memo-hint";
          hint.textContent = " â€¦"; // âœ… í´ë¦­ ìœ ë„ í‘œì‹œ
          title.appendChild(hint);

          wrap.appendChild(title);
          return { domNodes: [wrap] };
        }

        // ì—°ì°¨(ê¸°ì¡´)
        wrap.style.lineHeight = '1.15';

        if (!isMobile && half) {
          const oneLine = document.createElement('div');
          oneLine.textContent = `${arg.event.title}-${half}`;
          wrap.appendChild(oneLine);
          return { domNodes: [wrap] };
        }

        const name = document.createElement('div');
        name.textContent = arg.event.title;
        wrap.appendChild(name);

        if (half) {
          const sub = document.createElement('div');
          sub.textContent = half;
          sub.className = 'fc-half-label';
          wrap.appendChild(sub);
        }
        return { domNodes: [wrap] };
      },

      // âœ… í´ë¦­í•˜ë©´ ë©”ëª¨ ëª¨ë‹¬ ì—´ê¸°
      eventClick: function(info) {
        const e = info.event;
        const isMemo = String(e.id).startsWith("memo-");
        if (!isMemo) return;

        const title = e.title || "";
        const content = (e.extendedProps && e.extendedProps.content) ? e.extendedProps.content : "";
        openMemoModal(title, content);
      },

      // âœ… íˆ´íŒ(title ì†ì„±)ë„ ìœ ì§€
      eventDidMount: function(info) {
        const e = info.event;
        const p = e.extendedProps || {};

        if (String(e.id).startsWith("memo-")) {
          info.el.setAttribute("title", e.title);
        } else if (p.halfLabel) {
          info.el.setAttribute("title", `${e.title} (${p.halfLabel})`);
        }
      },
    });

    calendar.render();
    setTimeout(() => calendar.updateSize(), 0);
    window.addEventListener('resize', () => calendar.updateSize());
  });

  // ===== ì•„ë˜ ë³µì‚¬/ê³µìœ  í•¨ìˆ˜ë“¤ì€ ë„¤ ì½”ë“œ ê·¸ëŒ€ë¡œ ë‘¬ë„ ë¨ =====
  function copyToClipboard() { /* ... ë„¤ ê¸°ì¡´ ì½”ë“œ ... */ }
  function copyText() { /* ... ë„¤ ê¸°ì¡´ ì½”ë“œ ... */ }
  function showStatus(msg) { /* ... ë„¤ ê¸°ì¡´ ì½”ë“œ ... */ }
  function autoHide() { /* ... ë„¤ ê¸°ì¡´ ì½”ë“œ ... */ }
  async function shareText() { /* ... ë„¤ ê¸°ì¡´ ì½”ë“œ ... */ }
</script>


</body>
</html>