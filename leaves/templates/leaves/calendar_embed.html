<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>달력(임베드)</title>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
        /* ===== 공통: 메모 이벤트 기본 ===== */
    .fc-daygrid-event.fc-memo-event,
    .fc-daygrid-event.fc-memo-event .fc-event-main,
    .fc-daygrid-event.fc-memo-event .fc-event-main-frame,
    .fc-daygrid-event.fc-memo-event .fc-event-title-container {
      border: 0 !important;
      box-shadow: none !important;
    }

    /* 말풍선/모양 */
    .fc-daygrid-event.fc-memo-event {
      border-radius: 8px !important;
      padding: 2px 6px !important;
    }

    /* 타이틀 + 클릭유도(… / › / ⓘ 등) */
    .fc-daygrid-event.fc-memo-event .memo-title {
      font-weight: 800 !important;
    }

    .fc-daygrid-event.fc-memo-event .memo-hint {
      opacity: .85;
      font-weight: 900;
      margin-left: 2px;
    }

    /* PC: 한 줄만 */
    .memo-one-line .memo-title{
      display:block;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* 모바일: 2줄만 (호환성 경고 해결 포함) */
    .memo-clamp-2 .memo-title{
      display:-webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      line-clamp: 2;     /* ✅ 표준 속성 */
      overflow:hidden;
    }

    /* ===== 색상 클래스별 배경/글자색 ===== */
    .fc-daygrid-event.fc-memo-event.memo-yellow,
    .fc-daygrid-event.fc-memo-event.memo-yellow .fc-event-main {
      background:#FFD54A !important;
      border-color:#FFD54A !important;
    }
    .fc-daygrid-event.fc-memo-event.memo-yellow .memo-title,
    .fc-daygrid-event.fc-memo-event.memo-yellow .fc-event-title,
    .fc-daygrid-event.fc-memo-event.memo-yellow .fc-event-time {
      color:#2b2400 !important;
    }

    .fc-daygrid-event.fc-memo-event.memo-blue,
    .fc-daygrid-event.fc-memo-event.memo-blue .fc-event-main {
      background:#3B82F6 !important;
      border-color:#3B82F6 !important;
    }
    .fc-daygrid-event.fc-memo-event.memo-blue .memo-title,
    .fc-daygrid-event.fc-memo-event.memo-blue .fc-event-title,
    .fc-daygrid-event.fc-memo-event.memo-blue .fc-event-time {
      color:#ffffff !important;
    }

    .fc-daygrid-event.fc-memo-event.memo-green,
    .fc-daygrid-event.fc-memo-event.memo-green .fc-event-main {
      background:#16A34A !important;
      border-color:#16A34A !important;
    }
    .fc-daygrid-event.fc-memo-event.memo-green .memo-title,
    .fc-daygrid-event.fc-memo-event.memo-green .fc-event-title,
    .fc-daygrid-event.fc-memo-event.memo-green .fc-event-time {
      color:#eaffea !important;
    }

    .fc-daygrid-event.fc-memo-event.memo-red,
    .fc-daygrid-event.fc-memo-event.memo-red .fc-event-main {
      background:#EF4444 !important;
      border-color:#EF4444 !important;
    }
    .fc-daygrid-event.fc-memo-event.memo-red .memo-title,
    .fc-daygrid-event.fc-memo-event.memo-red .fc-event-title,
    .fc-daygrid-event.fc-memo-event.memo-red .fc-event-time {
      color:#ffffff !important;
    }

    /* ===== 모달 스타일 ===== */
    .memo-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
      padding:16px;
    }
    .memo-modal{
      width:min(560px, 100%);
      background:#fff;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .memo-modal-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .memo-modal-title{ font-weight:900; font-size:16px; }
    .memo-modal-close{
      border:0; background:transparent; font-size:18px; cursor:pointer;
    }
    .memo-modal-body{
      padding:14px;
      white-space:pre-wrap;
      line-height:1.45;
      font-size:14px;
    }



  </style>
</head>

<body>
  
  <div id="calendar"></div>

  <script>
  const EVENTS_URL = "{% url 'leaves:events_api' %}";
  const REQUEST_NEW_URL = "{% url 'leaves:request_new' %}";

  // ===== Modal helpers (기존 인증 모달) =====
  const backdrop = document.getElementById('authModalBackdrop');
  const selectedDateText = document.getElementById('selectedDateText');
  const birthInput = document.getElementById('birthInput');
  const authError = document.getElementById('authError');
  const btnCancel = document.getElementById('btnCancel');
  const btnOk = document.getElementById('btnOk');

  let selectedDateStr = null;

  function openAuthModal(dateStr) {
    selectedDateStr = dateStr;
    selectedDateText.textContent = dateStr;
    authError.textContent = '';
    birthInput.value = '';
    backdrop.style.display = 'flex';
    backdrop.setAttribute('aria-hidden', 'false');
    setTimeout(() => birthInput.focus(), 50);
  }

  function closeAuthModal() {
    backdrop.style.display = 'none';
    backdrop.setAttribute('aria-hidden', 'true');
    selectedDateStr = null;
  }

  function goRequestNew() {
    const birth = birthInput.value.trim();
    if (!selectedDateStr) return;

    if (!/^\d{6}$/.test(birth)) {
      authError.textContent = '생년월일 6자리 숫자로 입력해주세요. (예: 760910)';
      birthInput.focus();
      return;
    }

    window.location.href =
      `${REQUEST_NEW_URL}?date=${encodeURIComponent(selectedDateStr)}&birth=${encodeURIComponent(birth)}`;
  }

  btnCancel.addEventListener('click', closeAuthModal);
  btnOk.addEventListener('click', goRequestNew);

  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) closeAuthModal();
  });

  birthInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') goRequestNew();
    if (e.key === 'Escape') closeAuthModal();
  });

  // ===== ✅ Memo Modal (새로 추가) =====
  const memoBackdrop = document.getElementById("memoModalBackdrop");
  const memoTitleEl = document.getElementById("memoModalTitle");
  const memoBodyEl = document.getElementById("memoModalBody");
  const memoCloseBtn = document.getElementById("memoModalClose");

  function openMemoModal(title, content) {
    memoTitleEl.textContent = title || "(제목 없음)";
    memoBodyEl.textContent = content || "";
    memoBackdrop.style.display = "flex";
    memoBackdrop.setAttribute("aria-hidden", "false");
  }

  function closeMemoModal() {
    memoBackdrop.style.display = "none";
    memoBackdrop.setAttribute("aria-hidden", "true");
  }

  memoCloseBtn && memoCloseBtn.addEventListener("click", closeMemoModal);
  memoBackdrop && memoBackdrop.addEventListener("click", (e) => {
    if (e.target === memoBackdrop) closeMemoModal();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeMemoModal();
  });

  // ===== FullCalendar =====
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      dayMaxEventRows: 4,
      moreLinkClick: 'popover',
      aspectRatio: 2.05,
      height: 'auto',
      events: EVENTS_URL,

      headerToolbar: {
        left: 'title',
        center: '',
        right: 'myLeave today prev,next'
      },

      customButtons: {
        customTitle: { text: '' },
        myLeave: {
          text: '내 연차 보기',
          click: function () {
            window.location.href = "{% url 'leaves:me_lookup' %}";
          }
        }
      },

      buttonText: { today: 'today' },

      datesSet: function(info) {
        const d = new Date(info.view.currentStart);
        const month = d.getMonth() + 1;
        const year = d.getFullYear();

        const titleEl = document.querySelector('.fc .fc-toolbar-title');
        if (titleEl) {
          titleEl.innerHTML = `
            <span class="fc-title-month">${month}</span>
            <span class="fc-title-year">${year}</span>
          `;
        }
      },

      dateClick: function(info) {
        const today = new Date();
        today.setHours(0,0,0,0);
        const clicked = new Date(info.dateStr);

        if (clicked < today) {
          alert('과거 날짜에는 연차를 신청할 수 없습니다.');
          return;
        }
        openAuthModal(info.dateStr);
      },

      dayCellDidMount: function(arg) {
        const today = new Date();
        today.setHours(0,0,0,0);

        const cellDate = new Date(arg.date);
        cellDate.setHours(0,0,0,0);

        if (cellDate < today) {
          arg.el.style.backgroundColor = 'rgba(0,0,0,0.03)';
        }
      },

      // ✅ 메모: 타이틀만 + 클릭유도(…) / 모바일 2줄
      eventContent: function(arg) {
        const isMobile = window.matchMedia('(max-width: 480px)').matches;
        const wrap = document.createElement('div');

        const isMemo = String(arg.event.id).startsWith("memo-");
        const half = arg.event.extendedProps.halfLabel;

        if (isMemo) {
          wrap.className = "fc-event-wrap " + (isMobile ? "memo-clamp-2" : "memo-one-line");

          const title = document.createElement("div");
          title.className = "memo-title";
          title.textContent = arg.event.title;

          const hint = document.createElement("span");
          hint.className = "memo-hint";
          hint.textContent = " …"; // ✅ 클릭 유도 표시
          title.appendChild(hint);

          wrap.appendChild(title);
          return { domNodes: [wrap] };
        }

        // 연차(기존)
        wrap.style.lineHeight = '1.15';

        if (!isMobile && half) {
          const oneLine = document.createElement('div');
          oneLine.textContent = `${arg.event.title}-${half}`;
          wrap.appendChild(oneLine);
          return { domNodes: [wrap] };
        }

        const name = document.createElement('div');
        name.textContent = arg.event.title;
        wrap.appendChild(name);

        if (half) {
          const sub = document.createElement('div');
          sub.textContent = half;
          sub.className = 'fc-half-label';
          wrap.appendChild(sub);
        }
        return { domNodes: [wrap] };
      },

      // ✅ 클릭하면 메모 모달 열기
      eventClick: function(info) {
        const e = info.event;
        const isMemo = String(e.id).startsWith("memo-");
        if (!isMemo) return;

        const title = e.title || "";
        const content = (e.extendedProps && e.extendedProps.content) ? e.extendedProps.content : "";
        openMemoModal(title, content);
      },

      // ✅ 툴팁(title 속성)도 유지
      eventDidMount: function(info) {
        const e = info.event;
        const p = e.extendedProps || {};

        if (String(e.id).startsWith("memo-")) {
          info.el.setAttribute("title", e.title);
        } else if (p.halfLabel) {
          info.el.setAttribute("title", `${e.title} (${p.halfLabel})`);
        }
      },
    });

    calendar.render();
    setTimeout(() => calendar.updateSize(), 0);
    window.addEventListener('resize', () => calendar.updateSize());
  });

  // ===== 아래 복사/공유 함수들은 네 코드 그대로 둬도 됨 =====
  function copyToClipboard() { /* ... 네 기존 코드 ... */ }
  function copyText() { /* ... 네 기존 코드 ... */ }
  function showStatus(msg) { /* ... 네 기존 코드 ... */ }
  function autoHide() { /* ... 네 기존 코드 ... */ }
  async function shareText() { /* ... 네 기존 코드 ... */ }
</script>

      <!-- ✅ Memo Modal -->
    <div id="memoModalBackdrop" class="memo-backdrop" aria-hidden="true" style="display:none;">
      <div class="memo-modal" role="dialog" aria-modal="true" aria-labelledby="memoModalTitle">
        <div class="memo-modal-header">
          <div id="memoModalTitle" class="memo-modal-title"></div>
          <button type="button" id="memoModalClose" class="memo-modal-close" aria-label="닫기">✕</button>
        </div>
        <div id="memoModalBody" class="memo-modal-body"></div>
      </div>
    </div>
</body>
</html>
